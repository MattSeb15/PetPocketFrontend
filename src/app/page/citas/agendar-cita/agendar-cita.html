<div class="agendar-cita-container">
  <div class="header">
    <h1>Agendar Nueva Cita</h1>
  </div>

  <!-- Loader -->
  <div *ngIf="cargando && mascotas.length === 0" class="loader">
    <p>Cargando información...</p>
  </div>

  <!-- Formulario -->
  <form *ngIf="!cargando || mascotas.length > 0" (ngSubmit)="agendarCita()" class="form-cita">
    <!-- Error general -->
    <div *ngIf="error" class="error-message">
      {{ error }}
    </div>

    <!-- Sección 1: Información Básica -->
    <div class="form-section">
      <h2>Información Básica</h2>

      <div class="form-group">
        <label for="mascota">Mascota *</label>
        <select
          id="mascota"
          [(ngModel)]="cita.idMascota"
          name="mascota"
          class="form-control"
          required
        >
          <option [value]="0">Selecciona una mascota</option>
          <option *ngFor="let mascota of mascotas" [value]="mascota.idMascota">
            {{ mascota.nombre }} - {{ mascota.especie }}
            {{ mascota.raza ? '(' + mascota.raza + ')' : '' }}
          </option>
        </select>
      </div>

      <div class="form-group">
        <label for="servicio">Servicio *</label>
        <select
          id="servicio"
          [(ngModel)]="cita.idServicio"
          name="servicio"
          class="form-control"
          required
        >
          <option [value]="0">Selecciona un servicio</option>
          <option *ngFor="let servicio of servicios" [value]="servicio.idServicio">
            {{ servicio.nombre }}
            <span *ngIf="servicio.duracion"> - {{ servicio.duracion }} min</span>
          </option>
        </select>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label for="fecha">Fecha *</label>
          <input
            type="date"
            id="fecha"
            [(ngModel)]="cita.fecha"
            name="fecha"
            [min]="fechaMinima"
            (change)="verificarDisponibilidad()"
            class="form-control"
            required
          />
        </div>

        <div class="form-group">
          <label for="hora">Hora *</label>
          <input
            type="time"
            id="hora"
            [(ngModel)]="cita.hora"
            name="hora"
            (change)="verificarDisponibilidad()"
            class="form-control"
            required
          />
        </div>
      </div>

      <!-- Mensaje de disponibilidad -->
      <div *ngIf="verificandoDisponibilidad" class="verificando-message">
        Verificando disponibilidad...
      </div>
      <div
        *ngIf="!verificandoDisponibilidad && mensajeDisponibilidad"
        [class.disponible-message]="disponible"
        [class.no-disponible-message]="!disponible"
      >
        {{ mensajeDisponibilidad }}
      </div>

      <div class="form-group">
        <label for="veterinario">Veterinario (opcional)</label>
        <select
          id="veterinario"
          [(ngModel)]="cita.userIdUser"
          name="veterinario"
          (change)="verificarDisponibilidad()"
          class="form-control"
        >
          <option [ngValue]="null">Sin preferencia</option>
          <option *ngFor="let vet of veterinarios" [value]="vet.idUser">
            {{ vet.nombre }}
            <span *ngIf="vet.especialidad"> - {{ vet.especialidad }}</span>
          </option>
        </select>
      </div>
    </div>

    <!-- Sección 2: Detalles Médicos -->
    <div class="form-section">
      <h2>Detalles Médicos</h2>

      <div class="form-group">
        <label for="motivo">Motivo de la Consulta</label>
        <textarea
          id="motivo"
          [(ngModel)]="cita.motivo"
          name="motivo"
          rows="3"
          class="form-control"
          placeholder="Describe brevemente el motivo de la consulta..."
        ></textarea>
      </div>

      <div class="form-group">
        <label for="sintomas">Síntomas</label>
        <textarea
          id="sintomas"
          [(ngModel)]="cita.sintomas"
          name="sintomas"
          rows="3"
          class="form-control"
          placeholder="¿Qué síntomas presenta la mascota?"
        ></textarea>
      </div>

      <div class="form-group">
        <label for="diagnosticoPrevio">Diagnóstico Previo</label>
        <textarea
          id="diagnosticoPrevio"
          [(ngModel)]="cita.diagnosticoPrevio"
          name="diagnosticoPrevio"
          rows="2"
          class="form-control"
          placeholder="Si ya tiene un diagnóstico previo..."
        ></textarea>
      </div>

      <div class="form-group">
        <label>Tratamientos Anteriores</label>
        <div class="tratamientos-list">
          <div
            *ngFor="let trat of cita.tratamientosAnteriores; let i = index"
            class="tratamiento-item"
          >
            <span>{{ trat }}</span>
            <button type="button" (click)="eliminarTratamiento(i)" class="btn-eliminar-tratamiento">
              ✕
            </button>
          </div>
        </div>
        <div class="input-group">
          <input
            type="text"
            [(ngModel)]="tratamiento"
            name="tratamiento"
            class="form-control"
            placeholder="Agregar tratamiento anterior..."
            (keyup.enter)="agregarTratamiento()"
          />
          <button type="button" (click)="agregarTratamiento()" class="btn-agregar">
            + Agregar
          </button>
        </div>
      </div>

      <div class="form-group">
        <label for="notasAdicionales">Notas Adicionales</label>
        <textarea
          id="notasAdicionales"
          [(ngModel)]="cita.notasAdicionales"
          name="notasAdicionales"
          rows="3"
          class="form-control"
          placeholder="Cualquier información adicional relevante..."
        ></textarea>
      </div>
    </div>

    <!-- Botones de acción -->
    <div class="form-actions">
      <button type="button" (click)="cancelar()" class="btn-cancelar" [disabled]="cargando">
        Cancelar
      </button>
      <button type="submit" class="btn-agendar" [disabled]="cargando || !disponible">
        {{ cargando ? 'Agendando...' : 'Agendar Cita' }}
      </button>
    </div>
  </form>
</div>
